{# ana_uygulama/templates/ana_uygulama/nakliyeci/invoice_detail_nakliyeci.html #}
{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block page_title %}Fatura Detayı{% endblock page_title %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3 mb-0 text-gray-800">Fatura Detayı - #{{ invoice.invoice_number }}</h1>
        <div class="btn-group" role="group" aria-label="Fatura İşlemleri">
            {# Fatura durumu 'ODENDI' (Ödendi) veya 'IPTAL' (İptal Edildi) değilse, düzenleme ve ödeme butonlarını göster #}
            {% if invoice.status != 'ODENDI' and invoice.status != 'IPTAL' %}
            <a href="{% url 'ana_uygulama:invoice_update_nakliyeci_view' pk=invoice.pk %}" class="btn btn-warning btn-sm">
                <i class="fas fa-edit me-1"></i> Düzenle
            </a>
            {% endif %}
            {# Fatura durumu 'ODENDI' (Ödendi) veya 'IPTAL' (İptal Edildi) değilse, ödendi işaretle butonunu göster #}
            {% if invoice.status != 'ODENDI' and invoice.status != 'IPTAL' %}
            <a href="{% url 'ana_uygulama:invoice_mark_as_paid_nakliyeci_view' pk=invoice.pk %}" class="btn btn-success btn-sm">
                <i class="fas fa-money-bill-wave me-1"></i> Ödendi İşaretle
            </a>
            {% endif %}
            {# Faturayı silme butonu #}
            <a href="{% url 'ana_uygulama:invoice_delete_nakliyeci_view' pk=invoice.pk %}" class="btn btn-danger btn-sm">
                <i class="fas fa-trash me-1"></i> Sil
            </a>
        </div>
    </div>

    {% include 'ana_uygulama/includes/messages.html' %}

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Fatura Bilgileri</h6>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">Fatura Numarası:</dt>
                        <dd class="col-sm-8">{{ invoice.invoice_number }}</dd>

                        <dt class="col-sm-4">Fatura Tipi:</dt>
                        <dd class="col-sm-8">{{ invoice.get_invoice_type_display }}</dd>

                        <dt class="col-sm-4">Kesilen Firma (Fabrika):</dt>
                        <dd class="col-sm-8">{{ invoice.billed_to_factory.name }}</dd>

                        <dt class="col-sm-4">Kesen Firma (Nakliyeci):</dt>
                        <dd class="col-sm-8">{{ invoice.issued_by_shipper.name }}</dd>

                        <dt class="col-sm-4">İlgili Sevkiyat:</dt>
                        <dd class="col-sm-8">
                            {% if invoice.shipment %}
                                {# Sevkiyat detay URL'sini düzeltildi: 'pk' yerine 'shipment_id' kullanıldı #}
                                <a href="{% url 'ana_uygulama:shipment_detail_nakliyeci_view' shipment_id=invoice.shipment.pk %}" class="text-primary text-decoration-none">
                                    #{{ invoice.shipment.tracking_number }} ({{ invoice.shipment.origin }} - {{ invoice.shipment.destination }})
                                </a>
                            {% else %}
                                Yok
                            {% endif %}
                        </dd>

                        <dt class="col-sm-4">Kesim Tarihi:</dt>
                        <dd class="col-sm-8">{{ invoice.issue_date|date:"d M Y" }}</dd>

                        <dt class="col-sm-4">Vade Tarihi:</dt>
                        <dd class="col-sm-8">{{ invoice.due_date|date:"d M Y" }}</dd>

                        <dt class="col-sm-4">Toplam Tutar:</dt>
                        <dd class="col-sm-8">{{ invoice.total_amount|intcomma }} TL</dd>

                        <dt class="col-sm-4">KDV Oranı:</dt>
                        <dd class="col-sm-8">{% if invoice.vat_rate %}%{{ invoice.vat_rate}}{% else %}Belirtilmemiş{% endif %}</dd>

                        <dt class="col-sm-4">KDV Dahil Tutar:</dt>
                        <dd class="col-sm-8">{{ invoice.total_amount_with_vat|intcomma }} TL</dd>

                        <dt class="col-sm-4">Durum:</dt>
                        <dd class="col-sm-8">
                            <span class="badge {% if invoice.status == 'GÖNDERİLDİ' %}bg-info{% elif invoice.status == 'ODENDI' %}bg-success{% elif invoice.status == 'KISMİ_ÖDEME' %}bg-warning{% elif invoice.status == 'VADESİ_GEÇTİ' %}bg-danger{% elif invoice.status == 'IPTAL' %}bg-secondary{% endif %}">
                                {{ invoice.get_status_display }}
                            </span>
                        </dd>

                        <dt class="col-sm-4">Açıklama:</dt>
                        <dd class="col-sm-8">{% if invoice.description %}{{ invoice.description }}{% else %}Yok{% endif %}</dd>

                        <dt class="col-sm-4">Oluşturulma Tarihi:</dt>
                        <dd class="col-sm-8">{{ invoice.created_at|date:"d M Y H:i" }}</dd>

                        <dt class="col-sm-4">Son Güncelleme:</dt>
                        <dd class="col-sm-8">{{ invoice.updated_at|date:"d M Y H:i" }}</dd>
                    </dl>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">İlgili Ödemeler</h6>
                </div>
                <div class="card-body">
                    {% if invoice.payment_set.all %}
                        <ul class="list-group">
                            {% for payment in invoice.payment_set.all %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ payment.amount|intcomma }} TL - {{ payment.payment_date|date:"d M Y" }}
                                <span class="badge {% if payment.direction == 'INCOMING' %}bg-success{% else %}bg-info{% endif %}">
                                    {{ payment.get_direction_display }}
                                </span>
                                {# Ödeme detay URL'sini düzeltildi: 'pk' parametresi kullanıldı #}
                                <a href="{% url 'ana_uygulama:payment_detail_nakliyeci_view' pk=payment.pk %}" class="btn btn-info btn-sm">Detay</a>
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="alert alert-info" role="alert">
                            Bu fatura için henüz bir ödeme kaydedilmemiştir.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}
