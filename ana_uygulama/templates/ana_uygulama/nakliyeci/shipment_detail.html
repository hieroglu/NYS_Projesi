{# ana_uygulama/templates/ana_uygulama/nakliyeci/shipment_detail.html #}
{% extends "base.html" %}
{% load static %}

{% block page_title %}{{ page_title }}{% endblock page_title %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0">{{ page_title }}</h4>
        <div class="actions">
            {# "İşi Düzenle" butonu: Fatura kesilmemiş ve iptal edilmemişse göster #}
            {% if shipment.status != 'BILLED' and shipment.status != 'CANCELLED' %}
                <a href="{% url 'ana_uygulama:shipment_update_nakliyeci' shipment_id=shipment.id %}" class="btn btn-warning btn-sm">
                    <i class="fas fa-edit"></i> İşi Düzenle
                </a>
            {% endif %}
            {# "İşi Sil" butonu: Belirli durumlar haricinde göster #}
            {% if shipment.status not in 'BILLED,IN_TRANSIT,DELIVERED,COMPLETED' and shipment.status != 'CANCELLED' %} {# Hata burada düzeltildi #}
                <a href="{% url 'ana_uygulama:shipment_delete_nakliyeci' shipment_id=shipment.id %}" class="btn btn-danger btn-sm">
                    <i class="fas fa-trash"></i> İşi Sil
                </a>
            {% endif %}
            <a href="{% url 'ana_uygulama:shipment_list_nakliyeci' %}" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-left"></i> İşlere Geri Dön
            </a>
        </div>
    </div>
    <div class="card-body">
        {% include 'ana_uygulama/includes/messages.html' %}

        <div class="row mb-3">
            <div class="col-md-6"><strong>Sevkiyat ID:</strong> {{ shipment.pk }}</div>
            <div class="col-md-6"><strong>Müşteri Fabrika:</strong> {{ shipment.factory.name }}</div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6"><strong>Yükleme Yeri:</strong> {{ shipment.origin }}</div>
            <div class="col-md-6"><strong>Teslimat Yeri:</strong> {{ shipment.destination }}</div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6"><strong>Yükleme Tarihi:</strong> {{ shipment.pickup_date|date:"d M Y" }}</div>
            <div class="col-md-6"><strong>Teslim Tarihi:</strong> {% if shipment.delivery_date %}{{ shipment.delivery_date|date:"d M Y" }}{% else %}Belirtilmedi{% endif %}</div>
        </div>
        <div class="row mb-3">
            <div class="col-md-12"><strong>Yük Açıklaması:</strong> {{ shipment.load_description }}</div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6"><strong>Faturamdaki Tutar:</strong> {% if shipment.price_for_factory %}{{ shipment.price_for_factory|floatformat:2 }} TL{% else %}Belirtilmedi{% endif %}</div>
            <div class="col-md-6"><strong>Nakliyeciye Maliyet:</strong> {% if shipment.cost_for_shipper %}{{ shipment.cost_for_shipper|floatformat:2 }} TL{% else %}Belirtilmedi{% endif %}</div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6"><strong>Kâr Tutarı:</strong> {% if shipment.kar_tutari is not None %}{{ shipment.kar_tutari|floatformat:2 }} TL{% else %}Hesaplanamadı{% endif %}</div>
            <div class="col-md-6"><strong>Atanan Araç:</strong>
                {% if shipment.assigned_vehicle %}
                    <a href="{% url 'ana_uygulama:vehicle_detail_nakliyeci' vehicle_id=shipment.assigned_vehicle.pk %}">{{ shipment.assigned_vehicle.plate_number }}</a>
                    {% if shipment.assigned_vehicle.inspection_expiry_date and shipment.assigned_vehicle.inspection_expiry_date < today %}
                        <span class="badge bg-danger ms-1" data-bs-toggle="tooltip" title="Muayene Süresi Doldu"><i class="fas fa-exclamation-triangle"></i></span>
                    {% elif shipment.assigned_vehicle.inspection_expiry_date and shipment.assigned_vehicle.inspection_expiry_date <= thirty_days_later %}
                        <span class="badge bg-warning ms-1" data-bs-toggle="tooltip" title="Muayene Süresi Yaklaşıyor"><i class="fas fa-exclamation-circle"></i></span>
                    {% endif %}
                    {% if shipment.assigned_vehicle.insurance_expiry_date and shipment.assigned_vehicle.insurance_expiry_date < today %}
                        <span class="badge bg-danger ms-1" data-bs-toggle="tooltip" title="Sigorta Süresi Doldu"><i class="fas fa-shield-alt"></i></span>
                    {% elif shipment.assigned_vehicle.insurance_expiry_date and shipment.assigned_vehicle.insurance_expiry_date <= thirty_days_later %}
                        <span class="badge bg-warning ms-1" data-bs-toggle="tooltip" title="Sigorta Süresi Yaklaşıyor"><i class="fas fa-shield-alt"></i></span>
                    {% endif %}
                {% else %}
                    <span class="text-muted">Atanmamış</span>
                {% endif %}
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6"><strong>Mevcut Durum:</strong>
                {% if shipment.status == 'PENDING_ASSIGNMENT' %}
                    <span class="badge bg-info">{{ shipment.get_status_display }}</span>
                {% elif shipment.status == 'ASSIGNED' %}
                    <span class="badge bg-primary">{{ shipment.get_status_display }}</span>
                {% elif shipment.status == 'IN_TRANSIT' %}
                    <span class="badge bg-warning">{{ shipment.get_status_display }}</span>
                {% elif shipment.status == 'DELIVERED' %}
                    <span class="badge bg-success">{{ shipment.get_status_display }}</span>
                {% elif shipment.status == 'BILLED' %}
                    <span class="badge bg-secondary">{{ shipment.get_status_display }}</span>
                {% elif shipment.status == 'CANCELLED' %}
                    <span class="badge bg-danger">{{ shipment.get_status_display }}</span>
                {% else %}
                    <span class="badge bg-secondary">{{ shipment.get_status_display }}</span>
                {% endif %}
            </div>
            <div class="col-md-6"><strong>Oluşturma Tarihi:</strong> {{ shipment.created_at|date:"d M Y H:i" }}</div>
        </div>

        <hr>

        {# Durum Güncelleme Formu #}
        {% if shipment.status != 'BILLED' and shipment.status != 'CANCELLED' %}
        <h5 class="mt-4 mb-3">Durum Güncelleme</h5>
        <form action="{% url 'ana_uygulama:update_shipment_status_nakliyeci' shipment_id=shipment.id %}" method="post" class="row g-3 align-items-end">
            {% csrf_token %}
            <div class="col-md-4">
                <label for="{{ status_update_form.status.id_for_label }}" class="form-label">Yeni Durum</label>
                {{ status_update_form.status }}
                {% for error in status_update_form.status.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
            <br></br>
                <center>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sync-alt"></i> Durumu Güncelle
                </button>
                </center>
            </div>
            
        </form>
        {% endif %}

        <hr>

        {# Araç Atama/Değiştirme Butonu #}
        {% if shipment.status == 'PENDING_ASSIGNMENT' or shipment.status == 'ASSIGNED' %}
            <h5 class="mt-4 mb-3">Araç Atama</h5>
            <a href="{% url 'ana_uygulama:assign_vehicle_to_shipment' shipment_id=shipment.id %}" class="btn btn-warning btn-lg">
                <i class="fas fa-truck-pickup"></i> Araç Ata/Değiştir
            </a>
        {% endif %}

        {# Fatura Oluşturma Butonu (Sadece 'Teslim Edildi' durumunda ve faturası yoksa) #}
        {% if not shipment.invoice_set.exists and shipment.status == 'DELIVERED' %}
            <h5 class="mt-4 mb-3">Fatura Oluştur</h5>
            <a href="{% url 'ana_uygulama:invoice_create' shipment_id=shipment.id %}" class="btn btn-success btn-lg">
                <i class="fas fa-file-invoice-dollar"></i> Fatura Oluştur
            </a>
        {% endif %}

    </div>
</div>
{% endblock content %}

{# jQuery ve Bootstrap JS'i özel komut dosyalarınızdan önce yükleyin #}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" xintegrity="sha384-I7E8VVD/ismYTFyN+uQZ/Ltrj0D9PmnhjS7zRBhXp+L+FN8yI+3j+nK8s9g5wYh4" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" xintegrity="sha384-0pUGZvbkm6XF6gxjEnlco4nvBwDAwbgfmJKBCddhYlFbcM7ChtjKK9up/pQACGyK" crossorigin="anonymous"></script>

{% block extra_scripts %}
<script>
    $(function () {
        $('[data-bs-toggle="tooltip"]').tooltip();
    });
</script>
{% endblock extra_scripts %}
